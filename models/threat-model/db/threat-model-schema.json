{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://freeandfair.us/threat-model-schema.json",
  "title": "Tusk Voting System Threat Model",
  "description": "Schema for defining threat models including properties, attacks, mitigations, and contexts for the Tusk E2E-VIV voting system",
  "type": "object",
  "properties": {
    "properties": {
      "type": "object",
      "description": "Hierarchical security properties that the system should satisfy. Properties form an AND composition tree. Each property can be either a string (leaf property) or an array [description, children_dict] where children_dict contains child properties.",
      "patternProperties": {
        "^[a-zA-Z0-9_%+-]+$": {
          "oneOf": [
            {
              "type": "array",
              "description": "Property with description (first element) and child properties (second element as a dictionary)",
              "minItems": 2,
              "maxItems": 2,
              "prefixItems": [
                {
                  "type": "string",
                  "description": "Description of this property"
                },
                {
                  "type": "object",
                  "description": "Child properties as a dictionary",
                  "patternProperties": {
                    "^[a-zA-Z0-9_.%+-]+$": {
                      "$ref": "#/properties/properties/patternProperties/^[a-zA-Z0-9_%+-]+$"
                    }
                  }
                }
              ]
            },
            {
              "type": "string",
              "description": "Leaf property with only a description"
            }
          ]
        }
      }
    },
    "attacks": {
      "type": "array",
      "description": "Attack trees describing ways to undermine system properties. Parent-child relationships form OR compositions.",
      "items": {
        "$ref": "#/$defs/attack"
      }
    },
    "mitigations": {
      "type": "object",
      "description": "Flat structure of countermeasures to prevent or reduce impact of attacks",
      "patternProperties": {
        "^[a-zA-Z0-9_%+-]+$": {
          "type": "array",
          "description": "Mitigation definition: [name, description, scope]",
          "items": {
            "type": "string"
          },
          "minItems": 3,
          "maxItems": 3
        }
      }
    },
    "contexts": {
      "type": "object",
      "description": "Contexts describe where attacks are carried out (subsystems, networks, actors, primitives, data)",
      "patternProperties": {
        "^[a-zA-Z0-9_%+-]+$": {
          "type": "array",
          "description": "Context definition: [name, kind, optional description]",
          "items": {
            "type": "string"
          },
          "minItems": 2,
          "maxItems": 3
        }
      }
    },
    "stride": {
      "$ref": "#/$defs/property_mapping",
      "description": "STRIDE threat categories mapped to security properties"
    },
    "e-voting": {
      "$ref": "#/$defs/property_mapping",
      "description": "E-voting domain properties mapped to security properties"
    }
  },
  "$defs": {
    "attack": {
      "type": "object",
      "description": "An attack against the system, either abstract (template) or concrete (instantiated). Structure: {_: {attack fields}, children: [...], mitigations: [...]}",
      "properties": {
        "_": {
          "type": "object",
          "description": "Attack definition object (identifier will be auto-generated or explicitly set)",
          "properties": {
            "kind": {
              "type": "string",
              "enum": ["A", "S"],
              "description": "Attack kind: 'A' for Abstract (template), 'S' for Specific (concrete). Defaults to 'S' if omitted."
            },
            "name": {
              "type": "string",
              "description": "Human-readable name of the attack"
            },
            "description": {
              "type": "string",
              "description": "Detailed description of the attack. Use {X} for hyperlinks, {[X]} for citations."
            },
            "properties": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "List of property identifiers this attack targets"
            },
            "instance_of": {
              "type": "string",
              "description": "Identifier of the abstract attack this is an instance of"
            },
            "contexts": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of context identifiers where this attack can occur. Creates separate attack instances per context."
            },
            "parents": {
              "oneOf": [
                {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Additional parent attack identifiers (beyond hierarchical parent)"
                },
                {
                  "type": "string",
                  "description": "Single additional parent attack identifier"
                }
              ]
            }
          },
          "additionalProperties": false
        },
        "children": {
          "type": "array",
          "description": "Child attacks representing ways this attack can be carried out (OR composition). NOTE: This is a sibling of '_', not inside it.",
          "items": {
            "$ref": "#/$defs/attack"
          }
        },
        "mitigations": {
          "type": "array",
          "description": "Mitigations that address this attack. Format: [mitigation_name, rationale] or [mitigation_name, context, rationale]. NOTE: This is a sibling of '_', not inside it.",
          "items": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "minItems": 2,
            "maxItems": 3
          }
        }
      },
      "required": ["_"],
      "additionalProperties": false
    },
    "property_mapping": {
      "type": "object",
      "description": "Maps external property frameworks to internal security properties",
      "patternProperties": {
        "^[a-zA-Z0-9_%+-]+$": {
          "type": "array",
          "description": "Property mapping: [name, [related_property_identifiers]]",
          "prefixItems": [
            {
              "type": "string",
              "description": "Display name of the property"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of related internal property identifiers"
            }
          ],
          "minItems": 2,
          "maxItems": 2
        }
      }
    }
  }
}
